<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    body {
        /* background-color: #000; */
    }

    canvas {
        background-color: #fff;
    }
</style>

<body>
    <canvas id="myCanvas" width="1900" height="1060"></canvas>
    <div class="box2"></div>
    <div class="speed"></div>
    <button id="qie">切换</button>
</body>

</html>
<script>
    window.onload = function () {
        let imgNum = 0;// 当前播放的第几个图片
        let imgLength = 89;// total images 
        var num = 1;// 图片开始数字
        var list = [];//加载好后的图片存放
        var box2 = document.getElementsByClassName("box2")[0];
        var speedBox = document.getElementsByClassName("speed")[0];
        loadImage();
        var c = document.getElementById("myCanvas");
        var ctx = c.getContext("2d")
        let moveMouse = {
            oldX: 0,
            oldY: 0,
            clientX: 0,// 鼠标当前X轴
            clientY: 0,
            drection: false,//1,2,3,4 上右下左
            onClick: false,
            onUp: true,
        }
        function loadImage() {
            var img = new Image();
            img.src = "./pic/" + num + ".jpg";
            img.addEventListener("load", loadHandler);
        }
        function loadHandler(e) {
            list.push(this.cloneNode());//复制当前图片元素
            num++;
            if (num > 89) {
                ctx.drawImage(list[0], 0, 0);
                return;
            }
            this.src = "./pic/" + num + ".jpg"; //修改地址继续后触发load事件
        }
        //展示图片
        function showImg(newX, newY) {
            if (moveMouse.onClick && !moveMouse.onUp && Math.abs(moveMouse.oldX - moveMouse.clientX) > 15) { // 在鼠标点击后，未松开
                if (moveMouse.drection == 2) { // right 移动三个像素
                    imgNum = imgNum - 1 > 0 ? imgNum - 1 : imgLength - 1;
                    ctx.drawImage(list[imgNum], 0, 0);
                    moveMouse.oldX = newX;
                } else if (moveMouse.drection == 4) { // left 移动三个像素
                    imgNum = imgNum + 1 < imgLength ? imgNum + 1 : 0;
                    ctx.drawImage(list[imgNum], 0, 0);
                    moveMouse.oldX = newX;
                }
                box2.innerHTML = "X:" + newX + " Y: " + newY + "\n oldX:" + moveMouse.oldX + "oldY:" + moveMouse.oldY;
            }
        }
        // TODO:
        // 进度条动画
        // 点击进度条实现动画旋转
        // ted剩余网页

        // 每0.02秒有无松开鼠标，如果松开鼠标，记录该区间速度。将该速度衰平滑减至零
        let timeX = 0, moveSpeed = 0;
        let time = null, slideTime = null;// 计数器
        function getMoveSpeed() { // 获取鼠标移动速度
            clearInterval(time)
            time = setInterval(function () {
                moveSpeed = Math.abs(moveMouse.clientX - timeX);
                timeX = moveMouse.clientX;
                if (moveMouse.onUp) {
                    clearInterval(time)
                    transferspeed(moveSpeed)
                    // TODO 
                    // 鼠标划出组件的时候，不会触发 onUp事件
                }
                speedBox.innerHTML = "speeds: " + moveSpeed;
            }, 10)
        }

        function sleep(time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        function spining(frames) {
            frames = Math.floor(frames / 10);
        }
        async function transferspeed() {
            let drection=moveMouse.drection;
            moveSpeed = Math.floor(moveSpeed / 10)
            while (moveSpeed > 1) {
                moveSpeed -= 1;
                // await sleep(500)
                speedBox.innerHTML = "speeds: " + moveSpeed
                slideTime = setInterval(interval(drection), Math.floor(1000 / moveSpeed))
                await sleep(Math.floor(1000 / moveSpeed))
                clearInterval(slideTime)
                console.log(moveSpeed)
                // frames(moveS)
            }
        }

        function showImgSlide(speed, clientX) { // 滑动,延时参数错误
            let nowSpeed = Math.floor(100 - speed) > 0 ? Math.floor(100 - speed) : 1;
        }
        function interval(drection) {
            if (drection == 2) {
                imgNum = imgNum - 1 > 0 ? imgNum - 1 : imgLength - 1;
                ctx.drawImage(list[imgNum], 0, 0);
            } else if (drection == 4) {
                imgNum = imgNum + 1 < imgLength ? imgNum + 1 : 0;
                ctx.drawImage(list[imgNum], 0, 0);
            }
        }
        //*********** 实现切换效果  *************//
        function showImgSlide(imgUrlList, width, height, drection, time) {
            if (drection == 2) {//右
                ctx.drawImage(list[imgNum], sx, sy,);
            } else if (drection == 4) {//左

            }

        }


        // 鼠标点击
        c.onmousedown = function (event) {
            event = event || window.event;
            moveMouse.onClick = true;
            moveMouse.onUp = false;
            moveMouse.oldX = event.clientX;
            moveMouse.oldY = event.clientY;
            getMoveSpeed();
        }
        // 鼠标松开
        c.onmouseup = function () {
            moveMouse.onClick = false;
            moveMouse.onUp = true;

            // showImgSlide(moveSpeed, event.clientX);
        }
        // c.onmouseover = function () {
        //     moveMouse.onClick = false;
        //     moveMouse.onUp = true;
        // }
        // 绘制图片
        c.onmousemove = function (event) {
            event = event || window.event;
            moveMouse.clientX = event.clientX;
            moveMouse.drection = moveMouse.clientX - moveMouse.oldX > 0 ? 2 : 4;
            showImg(event.clientX, event.clientY)
        }
    }
</script>